name: demo-lowcodejs

services:
  demo-mongo:
    image: mongo:latest
    container_name: demo-mongo
    restart: unless-stopped
    environment:
      MONGO_INITDB_ROOT_USERNAME: demo
      MONGO_INITDB_ROOT_PASSWORD: demo
    volumes:
      - demo-mongo-volume:/data/db
    ports:
      - "27011:27017"
    networks:
      - demo-lowcodejs-network

  demo-api:
    container_name: demo-api
    build:
      context: ./api
      dockerfile: Dockerfile
    env_file:
      - ./api/.env.demo
    restart: unless-stopped
    ports:
      - "3001:3000"
    volumes:
      - demo-storage-api-volume:/app/_storage
    depends_on:
      - demo-mongo
    networks:
      - demo-lowcodejs-network
      - traefik-network
    labels:
      - "traefik.enable=true"

      # HTTPS (principal)
      - "traefik.http.routers.demo-api.rule=Host(`api.demo.lowcodejs.org`)"
      - "traefik.http.routers.demo-api.entrypoints=websecure"
      - "traefik.http.routers.demo-api.tls.certresolver=myresolver"
      - "traefik.http.services.demo-api.loadbalancer.server.port=3000"

      # HTTP para HTTPS redirect
      - "traefik.http.routers.demo-api-http.rule=Host(`api.demo.lowcodejs.org`)"
      - "traefik.http.routers.demo-api-http.entrypoints=web"
      - "traefik.http.routers.demo-api-http.middlewares=https-only@file"

      # Health check
      - "traefik.http.services.demo-api.loadbalancer.healthcheck.path=/health-check"
      - "traefik.http.services.demo-api.loadbalancer.healthcheck.port=3000"
      - "traefik.http.services.demo-api.loadbalancer.healthcheck.interval=10s"
      - "traefik.http.services.demo-api.loadbalancer.healthcheck.timeout=3s"

      # Retry middleware
      - "traefik.http.routers.demo-api.middlewares=demo-api-retry"
      - "traefik.http.middlewares.demo-api-retry.retry.attempts=3"
      - "traefik.http.middlewares.demo-api-retry.retry.initialinterval=500ms"

      # Sticky sessions
      - "traefik.http.services.demo-api.loadbalancer.sticky.cookie=true"

  demo-app:
    container_name: demo-app
    build:
      context: ./app
      dockerfile: Dockerfile
    env_file:
      - ./app/.env.demo
    ports:
      - "5171:80"
    depends_on:
      - demo-api
    networks:
      - demo-lowcodejs-network
      - traefik-network
    labels:
      - "traefik.enable=true"
      # HTTPS (principal)
      - "traefik.http.routers.demo-app.rule=Host(`demo.lowcodejs.org`)"
      - "traefik.http.routers.demo-app.entrypoints=websecure"
      - "traefik.http.routers.demo-app.tls.certresolver=myresolver"
      - "traefik.http.services.demo-app.loadbalancer.server.port=80"
      # HTTP para HTTPS redirect
      - "traefik.http.routers.demo-app-http.rule=Host(`demo.lowcodejs.org`)"
      - "traefik.http.routers.demo-app-http.entrypoints=web"
      - "traefik.http.routers.demo-app-http.middlewares=https-only@file"

volumes:
  demo-mongo-volume:
    driver: local
  demo-storage-api-volume:
    driver: local

networks:
  demo-lowcodejs-network:
    driver: bridge
  traefik-network:
    external: true
