name: ${ENVIRONMENT}-lowcodejs

services:
  mongo:
    image: mongo:latest
    restart: unless-stopped
    environment:
      MONGO_INITDB_ROOT_USERNAME: ${DB_USERNAME}
      MONGO_INITDB_ROOT_PASSWORD: ${DB_PASSWORD}
    volumes:
      - mongo-volume:/data/db
    networks:
      - traefik-network
    healthcheck:
      test: ["CMD", "mongosh", "--eval", "db.runCommand('ping')"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 60s

  api:
    image: ${DOCKER_USERNAME}/lowcodejs-api:${ENVIRONMENT}
    environment:
      NODE_ENV: production
      PORT: 3000
      DATABASE_URL: mongodb://${DB_USERNAME}:${DB_PASSWORD}@${ENVIRONMENT}-lowcodejs-mongo-1:27017/${DB_NAME}?authSource=admin
      DB_NAME: ${DB_NAME}
      APP_SERVER_URL: https://api.${ENVIRONMENT}.lowcodejs.org
      APP_CLIENT_URL: https://${ENVIRONMENT}.lowcodejs.org
      JWT_PRIVATE_KEY: ${JWT_PRIVATE_KEY}
      JWT_PUBLIC_KEY: ${JWT_PUBLIC_KEY}
      COOKIE_SECRET: ${COOKIE_SECRET}
      COOKIE_DOMAIN: ${COOKIE_DOMAIN}
      EMAIL_PROVIDER_PASSWORD: ${EMAIL_PROVIDER_PASSWORD}
      EMAIL_PROVIDER_USER: ${EMAIL_PROVIDER_USER}
      EMAIL_PROVIDER_HOST: ${EMAIL_PROVIDER_HOST}
      EMAIL_PROVIDER_PORT: ${EMAIL_PROVIDER_PORT}
      FILE_UPLOAD_MAX_SIZE: ${FILE_UPLOAD_MAX_SIZE:-10485760}
      FILE_UPLOAD_ACCEPTED: ${FILE_UPLOAD_ACCEPTED:-jpg;jpeg;png;pdf;doc;docx;xls;xlsx;txt;zip;rar}
      FILE_UPLOAD_MAX_FILES_PER_UPLOAD: ${FILE_UPLOAD_MAX_FILES_PER_UPLOAD:-10}
      LOCALE: ${LOCALE:-pt-br}
      LOGO_SMALL_URL: https://api.${ENVIRONMENT}.lowcodejs.org/storage/small.png
      LOGO_LARGE_URL: https://api.${ENVIRONMENT}.lowcodejs.org/storage/large.png
      PAGINATION_PER_PAGE: ${PAGINATION_PER_PAGE:-20}
    restart: unless-stopped
    volumes:
      - storage-api-volume:/app/_storage
    depends_on:
      mongo:
        condition: service_healthy
    networks:
      - traefik-network
    labels:
      - "traefik.enable=true"
      #- "traefik.http.routers.${ENVIRONMENT}-api.rule=Host(`api.${ENVIRONMENT}.lowcodejs.org`)"
      - "traefik.http.routers.${ENVIRONMENT}-api.rule=Host(`${API_HOST:-api.${ENVIRONMENT}.lowcodejs.org}`)"
      - "traefik.http.routers.${ENVIRONMENT}-api.entrypoints=websecure"
      - "traefik.http.routers.${ENVIRONMENT}-api.tls.certresolver=myresolver"
      - "traefik.http.services.${ENVIRONMENT}-api.loadbalancer.server.port=3000"
      #- "traefik.http.routers.${ENVIRONMENT}-api-http.rule=Host(`api.${ENVIRONMENT}.lowcodejs.org`)"
      - "traefik.http.routers.${ENVIRONMENT}-api-http.rule=Host(`${API_HOST:-api.${ENVIRONMENT}.lowcodejs.org}`)"
      - "traefik.http.routers.${ENVIRONMENT}-api-http.entrypoints=web"
      - "traefik.http.routers.${ENVIRONMENT}-api-http.middlewares=https-only@file"

  app:
    image: ${DOCKER_USERNAME}/lowcodejs-app:${ENVIRONMENT}
    restart: unless-stopped
    environment:
      VITE_API_BASE_URL: https://api.${ENVIRONMENT}.lowcodejs.org
      NITRO_PORT: 3000
      NITRO_HOST: 0.0.0.0
    # volumes:
    #   - app-public-volume:/app/.output/public
    depends_on:
      - api
    networks:
      - traefik-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3000"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    labels:
      - "traefik.enable=true"
      #- "traefik.http.routers.${ENVIRONMENT}-app.rule=Host(`${ENVIRONMENT}.lowcodejs.org`)"
      - "traefik.http.routers.${ENVIRONMENT}-app.rule=Host(`${APP_HOST:-${ENVIRONMENT}.lowcodejs.org}`)"
      - "traefik.http.routers.${ENVIRONMENT}-app.entrypoints=websecure"
      - "traefik.http.routers.${ENVIRONMENT}-app.tls.certresolver=myresolver"
      - "traefik.http.services.${ENVIRONMENT}-app.loadbalancer.server.port=3000"
      #- "traefik.http.routers.${ENVIRONMENT}-app-http.rule=Host(`${ENVIRONMENT}.lowcodejs.org`)"
      - "traefik.http.routers.${ENVIRONMENT}-app-http.rule=Host(`${APP_HOST:-${ENVIRONMENT}.lowcodejs.org}`)"
      - "traefik.http.routers.${ENVIRONMENT}-app-http.entrypoints=web"
      - "traefik.http.routers.${ENVIRONMENT}-app-http.middlewares=https-only@file"
      # Headers anti-cache para garantir que navegadores busquem sempre a vers√£o mais recente
      - "traefik.http.middlewares.${ENVIRONMENT}-app-headers.headers.customResponseHeaders.Cache-Control=no-cache, no-store, must-revalidate"
      - "traefik.http.middlewares.${ENVIRONMENT}-app-headers.headers.customResponseHeaders.Pragma=no-cache"
      - "traefik.http.middlewares.${ENVIRONMENT}-app-headers.headers.customResponseHeaders.Expires=0"
      - "traefik.http.routers.${ENVIRONMENT}-app.middlewares=${ENVIRONMENT}-app-headers"

volumes:
  mongo-volume:
    driver: local
  storage-api-volume:
    driver: local
  # app-public-volume:
  #   driver: local

networks:
  traefik-network:
    external: true
# 